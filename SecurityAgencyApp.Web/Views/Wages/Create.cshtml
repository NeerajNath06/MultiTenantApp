@model SecurityAgencyApp.Web.Models.Api.CreateWageRequest
@{
    ViewData["Title"] = "Create Wage Sheet";
    var guards = ViewBag.Guards as List<SecurityAgencyApp.Web.Models.Api.GuardItemDto>;
    var sites = ViewBag.Sites as List<SecurityAgencyApp.Web.Models.Api.SiteDto>;
    var shifts = ViewBag.Shifts as List<SecurityAgencyApp.Web.Models.Api.ShiftItemDto>;
}

<div class="page-header">
    <h1 class="page-title">Create Wage Sheet</h1>
    <p class="page-subtitle">Generate wage sheet for guards</p>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <form asp-action="Create" method="post" id="wageForm">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label asp-for="WageSheetNumber" class="form-label fw-semibold">Wage Sheet Number <span class="text-danger">*</span></label>
                    <input asp-for="WageSheetNumber" class="form-control" required />
                    <span asp-validation-for="WageSheetNumber" class="text-danger small"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="WagePeriodStart" class="form-label fw-semibold">Period Start <span class="text-danger">*</span></label>
                    <input asp-for="WagePeriodStart" type="date" class="form-control" required />
                    <span asp-validation-for="WagePeriodStart" class="text-danger small"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="WagePeriodEnd" class="form-label fw-semibold">Period End <span class="text-danger">*</span></label>
                    <input asp-for="WagePeriodEnd" type="date" class="form-control" required />
                    <span asp-validation-for="WagePeriodEnd" class="text-danger small"></span>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label asp-for="PaymentDate" class="form-label fw-semibold">Payment Date <span class="text-danger">*</span></label>
                    <input asp-for="PaymentDate" type="date" class="form-control" required />
                    <span asp-validation-for="PaymentDate" class="text-danger small"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Status" class="form-label fw-semibold">Status</label>
                    <select asp-for="Status" class="form-select">
                        <option value="Draft">Draft</option>
                        <option value="Approved">Approved</option>
                        <option value="Paid">Paid</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label asp-for="TotalAllowances" class="form-label fw-semibold">Total Allowances</label>
                    <input asp-for="TotalAllowances" type="number" step="0.01" class="form-control" value="0" onchange="calculateWageTotal()" />
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label asp-for="TotalDeductions" class="form-label fw-semibold">Total Deductions</label>
                    <input asp-for="TotalDeductions" type="number" step="0.01" class="form-control" value="0" onchange="calculateWageTotal()" />
                </div>
                <div class="col-md-6">
                    <label asp-for="Notes" class="form-label fw-semibold">Notes</label>
                    <input asp-for="Notes" class="form-control" />
                </div>
            </div>

            <!-- Wage Details -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Guard Wage Details</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addWageDetail()">
                        <i class="fas fa-plus me-1"></i>Add Guard
                    </button>
                </div>
                <div id="wageDetailsContainer">
                    <!-- Details will be added here dynamically -->
                </div>
            </div>

            <div class="card bg-light mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Total Wages:</strong> <span id="totalWages">₹0.00</span><br>
                            <strong>Total Allowances:</strong> <span id="totalAllowances">₹0.00</span><br>
                            <strong>Total Deductions:</strong> <span id="totalDeductions">₹0.00</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <h4>Net Amount: <span id="netAmount">₹0.00</span></h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Create Wage Sheet
                </button>
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let detailIndex = 0;
        const guards = @Html.Raw(guards != null ? Json.Serialize(guards.Select(g => new { id = g.Id.ToString(), name = $"{g.FirstName} {g.LastName}", code = g.GuardCode })) : "[]");
        const sites = @Html.Raw(sites != null ? Json.Serialize(sites.Select(s => new { id = s.Id.ToString(), name = s.SiteName })) : "[]");
        const shifts = @Html.Raw(shifts != null ? Json.Serialize(shifts.Select(s => new { id = s.Id.ToString(), name = s.ShiftName })) : "[]");

        function addWageDetail() {
            const container = document.getElementById('wageDetailsContainer');
            const detailHtml = `
                <div class="card mb-3 wage-detail" data-index="${detailIndex}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Guard ${detailIndex + 1}</h6>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeWageDetail(${detailIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Guard <span class="text-danger">*</span></label>
                                <select name="WageDetails[${detailIndex}].GuardId" class="form-select" required onchange="calculateWageTotal()">
                                    <option value="">Select Guard</option>
                                    ${(guards || []).map(g => `<option value="${g.id}">${g.code} - ${g.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Site</label>
                                <select name="WageDetails[${detailIndex}].SiteId" class="form-select">
                                    <option value="">Select Site</option>
                                    ${(sites || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Shift</label>
                                <select name="WageDetails[${detailIndex}].ShiftId" class="form-select">
                                    <option value="">Select Shift</option>
                                    ${(shifts || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label">Days Worked</label>
                                <input type="number" name="WageDetails[${detailIndex}].DaysWorked" class="form-control" min="0" value="0" onchange="calculateWageTotal()" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Hours Worked <span class="text-danger">*</span></label>
                                <input type="number" name="WageDetails[${detailIndex}].HoursWorked" class="form-control" min="0" value="0" required onchange="calculateWageTotal()" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Basic Rate <span class="text-danger">*</span></label>
                                <input type="number" name="WageDetails[${detailIndex}].BasicRate" class="form-control" step="0.01" min="0" value="0" required onchange="calculateWageTotal()" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Overtime Hours</label>
                                <input type="number" name="WageDetails[${detailIndex}].OvertimeHours" class="form-control" step="0.01" min="0" value="0" onchange="calculateWageTotal()" />
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-3">
                                <label class="form-label">Overtime Rate</label>
                                <input type="number" name="WageDetails[${detailIndex}].OvertimeRate" class="form-control" step="0.01" min="0" value="0" onchange="calculateWageTotal()" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Allowances</label>
                                <input type="number" name="WageDetails[${detailIndex}].Allowances" class="form-control" step="0.01" min="0" value="0" onchange="calculateWageTotal()" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Deductions</label>
                                <input type="number" name="WageDetails[${detailIndex}].Deductions" class="form-control" step="0.01" min="0" value="0" onchange="calculateWageTotal()" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Remarks</label>
                                <input type="text" name="WageDetails[${detailIndex}].Remarks" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', detailHtml);
            detailIndex++;
        }

        function removeWageDetail(index) {
            const detail = document.querySelector(`.wage-detail[data-index="${index}"]`);
            if (detail) {
                detail.remove();
                reindexWageDetails();
                calculateWageTotal();
            }
        }

        function reindexWageDetails() {
            const details = document.querySelectorAll('.wage-detail');
            details.forEach((detail, newIndex) => {
                const oldIndex = detail.getAttribute('data-index');
                detail.setAttribute('data-index', newIndex);
                
                detail.querySelectorAll('input, select, textarea').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name && name.includes(`[${oldIndex}]`)) {
                        input.setAttribute('name', name.replace(`[${oldIndex}]`, `[${newIndex}]`));
                    }
                });
                
                const detailNumber = detail.querySelector('h6');
                if (detailNumber) {
                    detailNumber.textContent = `Guard ${newIndex + 1}`;
                }
                
                const removeBtn = detail.querySelector('button[onclick*="removeWageDetail"]');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeWageDetail(${newIndex})`);
                }
            });
            detailIndex = details.length;
        }

        function calculateWageTotal() {
            let totalWages = 0;
            let totalAllowances = 0;
            let totalDeductions = 0;
            
            document.querySelectorAll('.wage-detail').forEach(detail => {
                const hoursWorked = parseFloat(detail.querySelector('input[name*="HoursWorked"]').value) || 0;
                const basicRate = parseFloat(detail.querySelector('input[name*="BasicRate"]').value) || 0;
                const overtimeHours = parseFloat(detail.querySelector('input[name*="OvertimeHours"]').value) || 0;
                const overtimeRate = parseFloat(detail.querySelector('input[name*="OvertimeRate"]').value) || 0;
                const allowances = parseFloat(detail.querySelector('input[name*="Allowances"]').value) || 0;
                const deductions = parseFloat(detail.querySelector('input[name*="Deductions"]').value) || 0;
                
                const basicAmount = hoursWorked * basicRate;
                const overtimeAmount = overtimeHours * overtimeRate;
                const grossAmount = basicAmount + overtimeAmount + allowances;
                
                totalWages += grossAmount;
                totalAllowances += allowances;
                totalDeductions += deductions;
            });
            
            const additionalAllowances = parseFloat(document.querySelector('input[name="TotalAllowances"]').value) || 0;
            const additionalDeductions = parseFloat(document.querySelector('input[name="TotalDeductions"]').value) || 0;
            
            totalAllowances += additionalAllowances;
            totalDeductions += additionalDeductions;
            
            const netAmount = totalWages + totalAllowances - totalDeductions;
            
            document.getElementById('totalWages').textContent = '₹' + totalWages.toFixed(2);
            document.getElementById('totalAllowances').textContent = '₹' + totalAllowances.toFixed(2);
            document.getElementById('totalDeductions').textContent = '₹' + totalDeductions.toFixed(2);
            document.getElementById('netAmount').textContent = '₹' + netAmount.toFixed(2);
        }

        // Add first detail on page load
        document.addEventListener('DOMContentLoaded', function() {
            addWageDetail();
        });
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
