@model SecurityAgencyApp.Web.Models.Api.UpdateBillRequest
@{
    ViewData["Title"] = "Edit Bill";
    var sites = ViewBag.Sites as List<SecurityAgencyApp.Web.Models.Api.SiteDto>;
    var clients = ViewBag.Clients as List<SecurityAgencyApp.Web.Models.Api.ClientItemDto>;
}

<div class="page-header">
    <h1 class="page-title">Edit Bill</h1>
    <p class="page-subtitle">Update bill information</p>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <form asp-action="Edit" method="post" id="billForm">
            <input type="hidden" asp-for="Id" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label asp-for="BillNumber" class="form-label fw-semibold">Bill Number <span class="text-danger">*</span></label>
                    <input asp-for="BillNumber" class="form-control" required />
                    <span asp-validation-for="BillNumber" class="text-danger small"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="BillDate" class="form-label fw-semibold">Bill Date <span class="text-danger">*</span></label>
                    <input asp-for="BillDate" type="date" class="form-control" required />
                    <span asp-validation-for="BillDate" class="text-danger small"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Status" class="form-label fw-semibold">Status</label>
                    <select asp-for="Status" class="form-select">
                        <option value="Draft">Draft</option>
                        <option value="Sent">Sent</option>
                        <option value="Paid">Paid</option>
                        <option value="Overdue">Overdue</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label asp-for="SiteId" class="form-label fw-semibold">Site (Optional)</label>
                    <select asp-for="SiteId" class="form-select">
                        <option value="">Select Site</option>
                        @if (sites != null)
                        {
                            @foreach (var site in sites)
                            {
                                <option value="@site.Id" selected="@(site.Id == Model.SiteId)">@site.SiteName - @site.ClientName</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label asp-for="ClientId" class="form-label fw-semibold">Client</label>
                    <select asp-for="ClientId" class="form-select">
                        <option value="">Select Client</option>
                        @if (clients != null)
                        {
                            @foreach (var client in clients)
                            {
                                <option value="@client.Id" selected="@(client.Id == Model.ClientId)">@client.CompanyName</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label asp-for="DueDate" class="form-label fw-semibold">Due Date</label>
                    <input asp-for="DueDate" type="date" class="form-control" />
                </div>
                <div class="col-md-6">
                    <label asp-for="PaymentTerms" class="form-label fw-semibold">Payment Terms</label>
                    <input asp-for="PaymentTerms" class="form-control" placeholder="e.g., Net 30" />
                </div>
            </div>

            <div class="mb-4">
                <label asp-for="Description" class="form-label fw-semibold">Description</label>
                <textarea asp-for="Description" class="form-control" rows="2"></textarea>
            </div>

            <!-- Bill Items -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Bill Items</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addBillItem()">
                        <i class="fas fa-plus me-1"></i>Add Item
                    </button>
                </div>
                <div id="billItemsContainer">
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <div class="bill-item-row border rounded p-3 mb-3">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">Item Name <span class="text-danger">*</span></label>
                                    <input name="Items[@i].ItemName" value="@Model.Items[i].ItemName" class="form-control" required />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Quantity <span class="text-danger">*</span></label>
                                    <input name="Items[@i].Quantity" type="number" value="@Model.Items[i].Quantity" class="form-control item-quantity" required />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Unit Price <span class="text-danger">*</span></label>
                                    <input name="Items[@i].UnitPrice" type="number" step="0.01" value="@Model.Items[i].UnitPrice" class="form-control item-price" required />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Tax Rate (%)</label>
                                    <input name="Items[@i].TaxRate" type="number" step="0.01" value="@Model.Items[i].TaxRate" class="form-control item-tax" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-semibold">Discount</label>
                                    <input name="Items[@i].DiscountAmount" type="number" step="0.01" value="@Model.Items[i].DiscountAmount" class="form-control item-discount" />
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-10">
                                    <label class="form-label fw-semibold">Description</label>
                                    <input name="Items[@i].Description" value="@Model.Items[i].Description" class="form-control" />
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeBillItem(this)">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Sub Total</label>
                    <input type="text" id="subTotal" class="form-control" readonly value="@Model.SubTotal.ToString("N2")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Discount</label>
                    <input type="text" id="totalDiscount" class="form-control" readonly value="@Model.DiscountAmount.ToString("N2")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Tax</label>
                    <input type="text" id="totalTax" class="form-control" readonly value="@Model.TaxAmount.ToString("N2")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-semibold">Total Amount</label>
                    <input type="text" id="totalAmount" class="form-control fw-bold" readonly value="@Model.TotalAmount.ToString("N2")" />
                </div>
            </div>

            <div class="mb-4">
                <label asp-for="Notes" class="form-label fw-semibold">Notes</label>
                <textarea asp-for="Notes" class="form-control" rows="3"></textarea>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>Update Bill
                </button>
                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-2"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let itemIndex = @Model.Items.Count;

        function addBillItem() {
            const container = document.getElementById('billItemsContainer');
            const itemHtml = `
                <div class="bill-item-row border rounded p-3 mb-3">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">Item Name <span class="text-danger">*</span></label>
                            <input name="Items[${itemIndex}].ItemName" class="form-control" required />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Quantity <span class="text-danger">*</span></label>
                            <input name="Items[${itemIndex}].Quantity" type="number" class="form-control item-quantity" required />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Unit Price <span class="text-danger">*</span></label>
                            <input name="Items[${itemIndex}].UnitPrice" type="number" step="0.01" class="form-control item-price" required />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Tax Rate (%)</label>
                            <input name="Items[${itemIndex}].TaxRate" type="number" step="0.01" class="form-control item-tax" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Discount</label>
                            <input name="Items[${itemIndex}].DiscountAmount" type="number" step="0.01" class="form-control item-discount" />
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-10">
                            <label class="form-label fw-semibold">Description</label>
                            <input name="Items[${itemIndex}].Description" class="form-control" />
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeBillItem(this)">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHtml);
            itemIndex++;
            attachCalculationListeners();
        }

        function removeBillItem(button) {
            button.closest('.bill-item-row').remove();
            recalculateTotals();
        }

        function attachCalculationListeners() {
            document.querySelectorAll('.item-quantity, .item-price, .item-tax, .item-discount').forEach(input => {
                input.removeEventListener('input', calculateTotals);
                input.addEventListener('input', calculateTotals);
            });
        }

        function calculateTotals() {
            let subTotal = 0;
            let totalTax = 0;
            let totalDiscount = 0;

            document.querySelectorAll('.bill-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity')?.value || 0);
                const price = parseFloat(row.querySelector('.item-price')?.value || 0);
                const taxRate = parseFloat(row.querySelector('.item-tax')?.value || 0);
                const discount = parseFloat(row.querySelector('.item-discount')?.value || 0);

                const itemAmount = quantity * price;
                const itemAfterDiscount = itemAmount - discount;
                const itemTax = itemAfterDiscount * (taxRate / 100);

                subTotal += itemAmount;
                totalDiscount += discount;
                totalTax += itemTax;
            });

            document.getElementById('subTotal').value = subTotal.toFixed(2);
            document.getElementById('totalDiscount').value = totalDiscount.toFixed(2);
            document.getElementById('totalTax').value = totalTax.toFixed(2);
            document.getElementById('totalAmount').value = (subTotal - totalDiscount + totalTax).toFixed(2);
        }

        function recalculateTotals() {
            // Re-index items after removal
            const rows = document.querySelectorAll('.bill-item-row');
            rows.forEach((row, index) => {
                row.querySelectorAll('input').forEach(input => {
                    const name = input.name;
                    if (name.includes('Items[')) {
                        input.name = name.replace(/Items\[\d+\]/, `Items[${index}]`);
                    }
                });
            });
            itemIndex = rows.length;
            calculateTotals();
        }

        // Initialize
        attachCalculationListeners();
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
